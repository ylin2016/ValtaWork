bookings = import_data() 
setwd("/Users/ylin/My Drive/Cohost/Cohost Cleaner Compensation/")

property <- read.xlsx('./Working/Data/Property_Cohost.xlsx')
property = property %>% 
  select(Listing, PropertyType,Region,OCCUPANCY, SqFt, BEDROOMS, BEDS, BATHROOMS) 

# Read cleaning data with fee calculations
cleaner <- read.xlsx('./Working/Data/Property_Cohost.xlsx',sheet='Cleaning')

data = merge(property,cleaner %>% select(Listing,Group,Cleaner.lead,Cleaning.fee),
             by="Listing",all=T) %>% 
  filter(!is.na(Cleaning.fee) & !is.na(SqFt) & !is.na(OCCUPANCY)) %>% 
  mutate(hottub = ifelse(Listing %in% c("Lilliwaup 28610", "Shelton 310", "Shelton 250", 
                                        "Hoodsport 26060", "Longbranch 6821", "Poulsbo 3956"),"Yes","No"),
         PropertyType = ifelse(PropertyType %in% c("Guest suite","Guesthouse"),
                               "Guesthouse_ADU",PropertyType))

Guests = bookings %>% filter(checkout_date>='2024-01-01' & checkout_date<='2025-09-30') %>%
  group_by(Listing) %>% reframe(avg_bookings_per_month = n()/21,
                                avg_rate = mean(AvgDailyRate,na.rm=T),
                                avg_rate_per_guest= mean(AvgDailyRate/guests,na.rm=T),
                                avg_guest = mean(guests,na.rm=T),
                                med_guest = median(guests,na.rm=T))

data = merge(data,Guests,by="Listing",all.x=T) %>% 
  filter(!Listing %in%  "Cottages All OSBR")

#summary(lm<-lm(Cleaning.fee ~ OCCUPANCY+SqFt+BEDROOMS+BEDS+BATHROOMS+hottub+PropertyType+med_guest+
#                 avg_bookings_per_month+avg_rate+avg_rate_per_guest,data=data))
#lm$fitted.values
#==============================================
library(rsample)      # data splitting 
library(randomForest) # basic implementation
library(ranger)       # a faster implementation of randomForest
library(caret)        # an aggregator package for performing many machine learning models

set.seed(123)
data_split <- initial_split(data, prop = .7)
data_train <- training(data_split)
data_test  <- testing(data_split)

predictors = data_train[,c("OCCUPANCY","SqFt","BEDROOMS","BEDS","BATHROOMS","hottub",
                           "PropertyType","med_guest","Region",
                           "avg_bookings_per_month","avg_rate","avg_rate_per_guest")]
outcome <- data_train$Cleaning.fee

ctrl <- trainControl(
  method = "repeatedcv",
  number = 5,
  repeats = 3,
  verboseIter = TRUE
)

rf_cv <- train(
  x = predictors,
  y = outcome,
  method = "rf",
  trControl = ctrl,
  tuneLength = 5,
  importance = TRUE
)

print(rf_cv)
plot(rf_cv)

varImpPlot(rf_cv$finalModel)

pred <- predict(rf_cv, data_test)
mse <- mean((pred - data_test$Cleaning.fee)^2)
print(paste("MSE:", round(mse, 2)))

save(rf_cv,data,data_split,file="/Users/ylin/My Drive/Cohost/Data and Reporting/05-Cleaning/CleaningFeeModel/Cleaningfee_RF.Rdata")
