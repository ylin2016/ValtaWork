distinct()
OwnerPayout = owner_payout %>%
group_by(Year,Property) %>%
reframe(OwnserDist=sum(Payout,na.rm = T)) %>%
filter(OwnserDist>0 & !is.na(Property)) %>%
pivot_wider(id_cols=Property,names_from=Year,values_from =OwnserDist)
###========================== Booking records ==========================
data = import_data() %>%
filter(!Listing %in% c("Bellevue 4551","Bothell 21833","NorthBend 44406",
"Ashford 137","Auburn 29123","Hoquiam 21")) %>%
mutate(Listing = ifelse(Listing %in% "Ocean Spray 3","Cottage 3",Listing))
daily <- data %>% select(checkin_date,checkout_date,Confirmation.Code,Listing,
DailyListingPrice,AvgDailyRate,Term) %>%
rowwise() %>%
mutate(date = purrr::pmap(list(checkin_date, checkout_date),
~ seq(from = ..1, to = ..2, by = "day")))%>% # nights only
unnest(date) %>%
ungroup() %>%
filter(date!=checkout_date) %>%
mutate(yearmonth = format(date,"%Y-%m"),
Year= format(date,"%Y"),Month= format(date,"%m"))
tmp = expand.grid(c("Revenue","ADR","OccRt"),2023:2025)
cols = paste(tmp$Var1,tmp$Var2,sep="_")
occupancy = daily %>%
mutate(yearmonth = format(date,"%Y-%m"),
Year= format(date,"%Y"),Month= format(date,"%m"))%>%
group_by(Listing,yearmonth,Year,Month) %>%
reframe(occdays=n(),
Revenue_occ=sum(DailyListingPrice,na.rm=T)) %>%
mutate(OccRt=occdays/days_in_month(as.Date(paste0(yearmonth,"-01"))))
monthly_STR = data %>% filter(Term %in% "STR") %>%
mutate(yearmonth = format(checkin_date,"%Y-%m")) %>%
group_by(Listing,yearmonth) %>%
reframe(Revenue = sum(total_revenue,na.rm = T)) %>%
full_join(occupancy %>% select(Listing,yearmonth,occdays,OccRt,Revenue_occ)) %>%
mutate(ADR = Revenue_occ/occdays) %>%
mutate_if(is.numeric,round,2) %>%
mutate(Revenue = ifelse(is.na(Revenue),0,Revenue)) %>%
arrange(Listing,yearmonth)
monthly_LTR = daily %>% filter(Term %in% "LTR") %>%
mutate(yearmonth = format(date,"%Y-%m"))%>%
group_by(Listing,yearmonth) %>%
reframe(occdays=n(),
Revenue_defer=sum(DailyListingPrice,na.rm=T)) %>%
mutate(OccRt=occdays/days_in_month(as.Date(paste0(yearmonth,"-01"))))
monthly = merge(monthly_STR,monthly_LTR,by=c("Listing",'yearmonth'),
all=T,suffix=c("",'.l')) %>%
mutate(Revenue = ifelse(!is.na(Revenue_defer),Revenue_occ,Revenue),
Year=substr(yearmonth,1,4),Month=substr(yearmonth,6,7))
monthly[,c("Reoccdays.l","Revenue_defer","OccRt.l")]=NULL
monthly_tab = monthly %>%
pivot_wider(id_cols=c(Listing,Month),names_from = Year,
values_from = c(Revenue,ADR,OccRt)) %>%
arrange(Listing,Month) %>%
select(Listing, Month, all_of(cols)) %>%
mutate(RevenueIncr2324 = Revenue_2024-Revenue_2023,
RevenueIncr2324_perc = ifelse(Revenue_2023 %in% c(NA,0),
NA,RevenueIncr2324/Revenue_2023),
RevenueIncr2425 = Revenue_2025-Revenue_2024,
RevenueIncr2425_perc = ifelse(Revenue_2024 %in% c(NA,0),
NA,RevenueIncr2425/Revenue_2024))
ReveuneIncr = rbind(monthly_tab %>%
select(Listing,Month, RevenueIncr=RevenueIncr2324,
RevenueIncr_perc=RevenueIncr2324_perc) %>%
mutate(yearmonth = paste0('2024-',Month)),
monthly_tab %>%
select(Listing,Month, RevenueIncr=RevenueIncr2425,
RevenueIncr_perc=RevenueIncr2425_perc) %>%
mutate(yearmonth = paste0('2025-',Month)))
monthly = merge(monthly,ReveuneIncr %>% select(-Month),
by=c("Listing","yearmonth"),all.x=T)
onboarding= data %>% group_by(Listing) %>%
reframe(onboarding = min(checkin_date,na.rm=T))
yearly = monthly %>%
group_by(Listing,Year) %>%
reframe(nights = sum(occdays,na.rm=T),
Revenue = sum(Revenue,na.rm = T),
ADR = sum(Revenue_occ,na.rm=T)/nights) %>%
mutate(days_year = as.integer(as.Date(paste0(Year,"-12-31"))-as.Date(paste0(Year,"-01-01"))+1)) %>%
mutate(OccRt=nights/days_year) %>%
mutate_if(is.numeric,round,2)
## !!!change including months and days_year calculate each month::
months.excl = c(10,11,12)
lastdate = "-09-30"
yearly_todate = merge(monthly %>% select(Listing,yearmonth,occdays,Revenue,Revenue_occ),
owner_payout %>% select(yearmonth,Property,Payout),
by.x=c('yearmonth',"Listing"),by.y=c('yearmonth',"Property"),all=T) %>%
mutate(Year=substr(yearmonth,1,4),Month=substr(yearmonth,6,7)) %>%
filter(Year %in% c(year(Sys.Date()),year(Sys.Date())-1) & !Month %in% months.excl) %>%
group_by(Listing,Year) %>%
reframe(nights = sum(occdays,na.rm=T),
Revenue = sum(Revenue,na.rm = T),
ADR = sum(Revenue_occ,na.rm=T)/nights,
Payout=sum(Payout,na.rm=T)) %>%
mutate(days_year = as.integer(as.Date(paste0(Year,lastdate))-as.Date(paste0(Year,"-01-01"))+1)) %>%
mutate(OccRt=nights/days_year) %>%
mutate_if(is.numeric,round,2) %>%
mutate(Time = ifelse(Year %in% year(Sys.Date()),"This_Yr","Last_Yr")) %>%
pivot_wider(id_cols=Listing,names_from = Time,
values_from = c(Revenue,ADR,OccRt,Payout)) %>%
select(Listing,Revenue_Last_Yr, ADR_Last_Yr,OccRt_Last_Yr,
Revenue_This_Yr, ADR_This_Yr, OccRt_This_Yr,Payout_Last_Yr,Payout_This_Yr)
yearly_todate[yearly_todate$Listing %in% 'Cottages All OSBR',"Revenue_Last_Yr"] =
sum(yearly_todate$Revenue_Last_Yr[grepl("Cottage",yearly_todate$Listing)],na.rm=T)
yearly_todate[yearly_todate$Listing %in% 'Cottages All OSBR',"Revenue_This_Yr"] =
sum(yearly_todate$Revenue_This_Yr[grepl("Cottage",yearly_todate$Listing)],na.rm=T)
yearly_todate[yearly_todate$Listing %in% 'Beachwood',"Revenue_Last_Yr"] =
sum(yearly_todate$Revenue_Last_Yr[grepl("Beachwood",yearly_todate$Listing)],na.rm=T)
yearly_todate[yearly_todate$Listing %in% 'Beachwood',"Revenue_This_Yr"] =
sum(yearly_todate$Revenue_This_Yr[grepl("Beachwood",yearly_todate$Listing)],na.rm=T)
yearly_todate = yearly_todate %>%
mutate(owner_pay_perc_today =Payout_This_Yr/Revenue_This_Yr,
Revenue_ratio_today = Revenue_This_Yr/Revenue_Last_Yr,
Revenue_hlt_today = ifelse(Revenue_ratio_today<0.95,"Loss",""))
yearly_tab = yearly %>% filter(Year %in% c(year(Sys.Date()),year(Sys.Date())-1)) %>%
mutate(Time = ifelse(Year %in% year(Sys.Date()),"This_Yr","Last_Yr")) %>%
pivot_wider(id_cols=Listing,names_from = Time,
values_from = c(Revenue,ADR,OccRt)) %>%
select(Listing,Revenue_Last_Yr, ADR_Last_Yr,OccRt_Last_Yr,
Revenue_This_Yr, ADR_This_Yr, OccRt_This_Yr)
yearly_tab[yearly_tab$Listing %in% 'Cottages All OSBR',"Revenue_Last_Yr"] =
sum(yearly_tab$Revenue_Last_Yr[grepl("Cottage",yearly_tab$Listing)],na.rm=T)
yearly_tab[yearly_tab$Listing %in% 'Cottages All OSBR',"Revenue_This_Yr"] =
sum(yearly_tab$Revenue_This_Yr[grepl("Cottage",yearly_tab$Listing)],na.rm=T)
yearly_tab = rbind.fill(yearly_tab,data.frame(Listing="Beachwood"))
yearly_tab[yearly_tab$Listing %in% 'Beachwood',c("Revenue_Last_Yr","Revenue_This_Yr")] =
c(sum(yearly_tab$Revenue_Last_Yr[grepl("Beachwood",yearly_tab$Listing)],na.rm=T),
sum(yearly_tab$Revenue_This_Yr[grepl("Beachwood",yearly_tab$Listing)],na.rm=T))
colnames(OwnerPayout) = c("Listing","OwnerDist_Last_Yr","OwnerDist_This_Yr")
yearly_tab = merge(yearly_tab,OwnerPayout,by='Listing',all=T) %>%
select(Listing,Revenue_Last_Yr, ADR_Last_Yr,OccRt_Last_Yr,OwnerDist_Last_Yr,
Revenue_This_Yr, ADR_This_Yr, OccRt_This_Yr,OwnerDist_This_Yr) %>%
mutate(owner_pay_perc_last = OwnerDist_Last_Yr/Revenue_Last_Yr,
owner_pay_perc_this =OwnerDist_This_Yr/Revenue_This_Yr,
Revenue_ratio = Revenue_This_Yr/Revenue_Last_Yr,
Revenue_hlt = ifelse(Revenue_ratio<0.95,"Loss",""))
yearly_tab = merge(yearly_tab,yearly_todate %>%
select(Listing,Revenue_thismonth = Revenue_This_Yr,
owner_pay_perc_today,Revenue_ratio_today,Revenue_hlt_today),
by="Listing",all.x=T)
yearly_tab
yearly_tab[1,]
Payout = yearly_tab %>%
mutate(Delta = owner_pay_perc_today-owner_pay_perc_last,
flag = ifelse(Delta< (-0.02),
ifelse(Revenue_This_Yr<Revenue_Last_Yr,"High","Med"),"Low")) %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr,
owner_pay_perc_last,owner_pay_perc_todayflag,Delta)
Payout = yearly_tab %>%
mutate(Delta = owner_pay_perc_today-owner_pay_perc_last,
flag = ifelse(Delta< (-0.02),
ifelse(Revenue_This_Yr<Revenue_Last_Yr,"High","Med"),"Low")) %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr,
flag,owner_pay_perc_last,owner_pay_perc_today,Delta)
View(Payout)
Payout = yearly_tab %>%
mutate(Delta = owner_pay_perc_today-owner_pay_perc_last,
flag = ifelse(Delta< (-0.02),
ifelse(Revenue_This_Yr<Revenue_Last_Yr,"High","Med"),"Low"),
owner_pay_perc_today = ifelse(owner_pay_perc_today %in% 0,NA,owner_pay_perc_today)) %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr,
flag,owner_pay_perc_last,owner_pay_perc_today,Delta)
Payout = yearly_tab %>%
mutate(owner_pay_perc_today = ifelse(owner_pay_perc_today %in% 0,NA,owner_pay_perc_today),
Delta = owner_pay_perc_today-owner_pay_perc_last,
flag = ifelse(Delta< (-0.02),
ifelse(Revenue_This_Yr<Revenue_Last_Yr,"High","Med"),"Low")) %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr,
flag,owner_pay_perc_last,owner_pay_perc_today,Delta)
Payout = yearly_tab %>%
mutate(owner_pay_perc_today =
ifelse(owner_pay_perc_today %in% 0,NA,owner_pay_perc_today),
Revenue_thismonth = ifelse(Revenue_thismonth %in% 0, NA,Revenue_thismonth),
Delta = owner_pay_perc_today-owner_pay_perc_last,
flag = ifelse(Delta< (-0.02),
ifelse(Revenue_This_Yr<Revenue_Last_Yr,"High","Med"),"Low")) %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr,
flag,owner_pay_perc_last,owner_pay_perc_today,Delta)
monthly[1,]
owner_payout[1,]
pay.path = "/Users/ylin/My Drive/Cohost/Accounting/"
y25 = paste0('2025.',c(paste0(0,1:9),10:12))
y24 = sub(2025,2024,y25)
owner_payout=NULL
for(k in c(y24[12],y25[1:9]))
{
tmp = read.xlsx(paste0(pay.path,"01-OwnerPayout Records.xlsx"),sheet=k)
owner_payout = rbind(owner_payout,tmp[,c(1,3,5)])
}
for(k in y24[-12])
{
tmp = read.xlsx(paste0(pay.path,"/* Monthly/0-Process & Template/Old files/",
"2024 OwnerPayout Records.xlsx"),sheet=k)
if(!k %in% '2024.11')
{
owner_payout = rbind(owner_payout,data.frame(Date=k,tmp[,c(2,4)]))
}else{
owner_payout = rbind(owner_payout,tmp[,c(1,3,5)])
}
}
jing_property = data.frame(Date=rep(c("2024.05","2024.06","2024.07"),each=4),
Property = c("Elektra 1004",
"Elektra 1108","Elektra 1115","Microsoft 14615-D303"),
Payout = c(-325.99,3942.64,1627.11,3150.69,
4345.90,1249.86,3954.50,3929.28,
1824.40,2392.14,3247.69,4060.26))
owner_payout = rbind(owner_payout %>% filter(!grepl("Jing",Property)),jing_property)
owner_payout = owner_payout %>%
mutate(Year = substr(Date,1,4),
yearmonth = sub(".","-",Date,fixed=T),
Property=trimws(Property,which="right"),
Property=sub("Island ","",Property)) %>%
mutate(Property=sub("SeaTac","Seatac",Property,fixed=T))
txt =c("Microsoft 14645 C19","Microsoft 14620 E205","E205","D201",
"Kirkland D201","Kirkland 11321 - corrected","OSBR - All","OSBR",
"Burien 14407 Middle","Burien 14407 Top","Seatac 12834 - Lower",
"Seatac 12834 - Upper","Bellevue 13020 - already paid")
change = c("Microsoft 14645-C19","Microsoft 14620-E205",
"Total","Kirkland 8252-D201","Kirkland 8252-D201",
"Kirkland 11321","Cottages All OSBR","Cottages All OSBR",
"Burien 14407 middle","Burien 14407 top",
"Seatac 12834 Lower", "Seatac 12834 Upper","Bellevue 13020")
for(i in 1:length(txt))
owner_payout$Property[owner_payout$Property %in% txt[i]] = change[i]
owner_payout = owner_payout %>% select(yearmonth,Property,Payout) %>%
filter(!grepl("Total",Property) & !Payout %in% c(NA,0)) %>%
group_by(Property,yearmonth) %>%
reframe(Year=substr(yearmonth,1,4),
Payout=sum(Payout,na.rm=T))%>%
distinct()
OwnerPayout = owner_payout %>%
group_by(Year,Property) %>%
reframe(OwnserDist=sum(Payout,na.rm = T)) %>%
filter(OwnserDist>0 & !is.na(Property)) %>%
pivot_wider(id_cols=Property,names_from=Year,values_from =OwnserDist)
###========================== Booking records ==========================
data = import_data() %>%
filter(!Listing %in% c("Bellevue 4551","Bothell 21833","NorthBend 44406",
"Ashford 137","Auburn 29123","Hoquiam 21")) %>%
mutate(Listing = ifelse(Listing %in% "Ocean Spray 3","Cottage 3",Listing))
daily <- data %>% select(checkin_date,checkout_date,Confirmation.Code,Listing,
DailyListingPrice,AvgDailyRate,Term) %>%
rowwise() %>%
mutate(date = purrr::pmap(list(checkin_date, checkout_date),
~ seq(from = ..1, to = ..2, by = "day")))%>% # nights only
unnest(date) %>%
ungroup() %>%
filter(date!=checkout_date) %>%
mutate(yearmonth = format(date,"%Y-%m"),
Year= format(date,"%Y"),Month= format(date,"%m"))
tmp = expand.grid(c("Revenue","ADR","OccRt"),2023:2025)
cols = paste(tmp$Var1,tmp$Var2,sep="_")
occupancy = daily %>%
mutate(yearmonth = format(date,"%Y-%m"),
Year= format(date,"%Y"),Month= format(date,"%m"))%>%
group_by(Listing,yearmonth,Year,Month) %>%
reframe(occdays=n(),
Revenue_occ=sum(DailyListingPrice,na.rm=T)) %>%
mutate(OccRt=occdays/days_in_month(as.Date(paste0(yearmonth,"-01"))))
monthly_STR = data %>% filter(Term %in% "STR") %>%
mutate(yearmonth = format(checkin_date,"%Y-%m")) %>%
group_by(Listing,yearmonth) %>%
reframe(Revenue = sum(total_revenue,na.rm = T)) %>%
full_join(occupancy %>% select(Listing,yearmonth,occdays,OccRt,Revenue_occ)) %>%
mutate(ADR = Revenue_occ/occdays) %>%
mutate_if(is.numeric,round,2) %>%
mutate(Revenue = ifelse(is.na(Revenue),0,Revenue)) %>%
arrange(Listing,yearmonth)
monthly_LTR = daily %>% filter(Term %in% "LTR") %>%
mutate(yearmonth = format(date,"%Y-%m"))%>%
group_by(Listing,yearmonth) %>%
reframe(occdays=n(),
Revenue_defer=sum(DailyListingPrice,na.rm=T)) %>%
mutate(OccRt=occdays/days_in_month(as.Date(paste0(yearmonth,"-01"))))
monthly = merge(monthly_STR,monthly_LTR,by=c("Listing",'yearmonth'),
all=T,suffix=c("",'.l')) %>%
mutate(Revenue = ifelse(!is.na(Revenue_defer),Revenue_occ,Revenue),
Year=substr(yearmonth,1,4),Month=substr(yearmonth,6,7))
monthly[,c("Reoccdays.l","Revenue_defer","OccRt.l","occdays.l")]=NULL
monthly = merge(monthly,owner_payout %>% select(Listing=Property,yearmonth,Payout),
by=c("Listing",'yearmonth'),all.x=T)
monthly[1,]
monthly_tab = monthly %>%
pivot_wider(id_cols=c(Listing,Month),names_from = Year,
values_from = c(Revenue,ADR,OccRt,Payout)) %>%
arrange(Listing,Month) %>%
select(Listing, Month, all_of(cols)) %>%
mutate(RevenueIncr2324 = Revenue_2024-Revenue_2023,
RevenueIncr2324_perc = ifelse(Revenue_2023 %in% c(NA,0),
NA,RevenueIncr2324/Revenue_2023),
RevenueIncr2425 = Revenue_2025-Revenue_2024,
RevenueIncr2425_perc = ifelse(Revenue_2024 %in% c(NA,0),
NA,RevenueIncr2425/Revenue_2024))
ReveuneIncr = rbind(monthly_tab %>%
select(Listing,Month, RevenueIncr=RevenueIncr2324,
RevenueIncr_perc=RevenueIncr2324_perc) %>%
mutate(yearmonth = paste0('2024-',Month)),
monthly_tab %>%
select(Listing,Month, RevenueIncr=RevenueIncr2425,
RevenueIncr_perc=RevenueIncr2425_perc) %>%
mutate(yearmonth = paste0('2025-',Month)))
monthly = merge(monthly,ReveuneIncr %>% select(-Month),
by=c("Listing","yearmonth"),all.x=T)
onboarding= data %>% group_by(Listing) %>%
reframe(onboarding = min(checkin_date,na.rm=T))
yearly = monthly %>%
group_by(Listing,Year) %>%
reframe(nights = sum(occdays,na.rm=T),
Revenue = sum(Revenue,na.rm = T),
ADR = sum(Revenue_occ,na.rm=T)/nights) %>%
mutate(days_year = as.integer(as.Date(paste0(Year,"-12-31"))-as.Date(paste0(Year,"-01-01"))+1)) %>%
mutate(OccRt=nights/days_year) %>%
mutate_if(is.numeric,round,2)
ls()
property_input
property = property_input()$cohost
Payout = yearly_tab %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr) %>%
join(property %>% select(Property,Listing)) %>%
group_by(Property) %>%
summarise(is.numeric,sum,na.rm=T)
Payout = yearly_tab %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr) %>%
join(property %>% select(Property,Listing)) %>%
group_by(Property) %>%
summarise(across(where(is.numeric), sum,na.rm=T))
?join
Payout = yearly_tab %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr) %>%
left_join(property %>% select(Property,Listing)) %>%
group_by(Property) %>%
summarise(across(where(is.numeric), sum,na.rm=T))
dim(yearly_tab)
dim(Payout)
Payout = yearly_tab %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr) %>%
left_join(property %>% select(Property,Listing))
dim(Payout)
Payout = yearly_tab %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr) %>%
left_join(property %>% select(Property,Listing)) %>%
mutate(Property = ifelse(is.na(Property),sub(" Lower| Upper","",Listing),Property))
Payout = yearly_tab %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr) %>%
left_join(property %>% select(Property,Listing)) %>%
mutate(Property = ifelse(is.na(Property),sub(" Lower| Upper","",Listing),Property)) %>%
group_by(Property) %>%
summarise(across(where(is.numeric), sum,na.rm=T))
dim(Payout)
Payout = yearly_tab %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr) %>%
left_join(property %>% select(Property,Listing)) %>%
mutate(Property = ifelse(is.na(Property),sub(" Lower| Upper","",Listing),Property)) %>%
group_by(Property) %>%
summarise(across(where(is.numeric), sum,na.rm=T)) %>%
mutate(owner_pay_perc_last = OwnerDist_Last_Yr/Revenue_Last_Yr,
owner_pay_perc_today =OwnerDist_This_Yr/Revenue_thismonth,
Delta = owner_pay_perc_today-owner_pay_perc_last,
flag = ifelse(Delta< (-0.02),
ifelse(Revenue_This_Yr<Revenue_Last_Yr,"High","Med"),"Low"))
Payout = yearly_tab %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr) %>%
left_join(property %>% select(Property,Listing)) %>%
mutate(Property = ifelse(is.na(Property),sub(" Lower| Upper","",Listing),Property)) %>%
group_by(Property) %>%
summarise(across(where(is.numeric), sum,na.rm=T)) %>%
mutate(owner_pay_perc_last = OwnerDist_Last_Yr/Revenue_Last_Yr,
owner_pay_perc_today =OwnerDist_This_Yr/Revenue_thismonth,
Delta = owner_pay_perc_today-owner_pay_perc_last,
flag = ifelse(Delta< (-0.02),
ifelse(Projected_Revenue<Revenue_Last_Yr,"High","Med"),"Low"))
?coalesce
Payout = yearly_tab %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr) %>%
left_join(property %>% select(Property,Listing)) %>%
mutate(Property = ifelse(is.na(Property),sub(" Lower| Upper","",Listing),Property)) %>%
group_by(Property) %>%
summarise(across(where(is.numeric), sum,na.rm=T)) %>% na_if(0) %>%
mutate(owner_pay_perc_last = OwnerDist_Last_Yr/Revenue_Last_Yr,
owner_pay_perc_today =OwnerDist_This_Yr/Revenue_thismonth,
Delta = owner_pay_perc_today-owner_pay_perc_last,
flag = ifelse(Delta< (-0.02),
ifelse(Projected_Revenue<Revenue_Last_Yr,"High","Med"),"Low"))
Payout = yearly_tab %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr) %>%
left_join(property %>% select(Property,Listing)) %>%
mutate(Property = ifelse(is.na(Property),sub(" Lower| Upper","",Listing),Property)) %>%
group_by(Property) %>%
summarise(across(where(is.numeric), sum,na.rm=T)) %>%
mutate_at(is.numeric,na_if(0)) %>%
mutate(owner_pay_perc_last = OwnerDist_Last_Yr/Revenue_Last_Yr,
owner_pay_perc_today =OwnerDist_This_Yr/Revenue_thismonth,
Delta = owner_pay_perc_today-owner_pay_perc_last,
flag = ifelse(Delta< (-0.02),
ifelse(Projected_Revenue<Revenue_Last_Yr,"High","Med"),"Low"))
Payout = yearly_tab %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr) %>%
left_join(property %>% select(Property,Listing)) %>%
mutate(Property = ifelse(is.na(Property),sub(" Lower| Upper","",Listing),Property)) %>%
group_by(Property) %>%
summarise(across(where(is.numeric), sum,na.rm=T)) %>%
mutate_if(is.numeric,na_if(0)) %>%
mutate(owner_pay_perc_last = OwnerDist_Last_Yr/Revenue_Last_Yr,
owner_pay_perc_today =OwnerDist_This_Yr/Revenue_thismonth,
Delta = owner_pay_perc_today-owner_pay_perc_last,
flag = ifelse(Delta< (-0.02),
ifelse(Projected_Revenue<Revenue_Last_Yr,"High","Med"),"Low"))
Payout = yearly_tab %>%
select(Listing,Revenue_Last_Yr,OwnerDist_Last_Yr,
Projected_Revenue=Revenue_This_Yr,
Revenue_thismonth,OwnerDist_This_Yr) %>%
left_join(property %>% select(Property,Listing)) %>%
mutate(Property = ifelse(is.na(Property),sub(" Lower| Upper","",Listing),Property)) %>%
group_by(Property) %>%
summarise(across(where(is.numeric), sum,na.rm=T)) %>%
mutate(across(where(is.numeric), ~na_if(., 0))) %>%
mutate(owner_pay_perc_last = OwnerDist_Last_Yr/Revenue_Last_Yr,
owner_pay_perc_today =OwnerDist_This_Yr/Revenue_thismonth,
Delta = owner_pay_perc_today-owner_pay_perc_last,
flag = ifelse(Delta< (-0.02),
ifelse(Projected_Revenue<Revenue_Last_Yr,"High","Med"),"Low"))
rm(list=ls())
source("/Users/ylin/My Drive/Cohost/Data and Reporting/Codes/RevenueReport.R")
# 9/11/2025: create revenue table per property
library(plyr)
library(dplyr)
library(tidyr)
library(openxlsx)
library(lubridate)
setwd("/Users/ylin/ValtaWork/Valta_BookingManagement/")
source('./Codes/DataProcess.R')
###========================== owner payouts ==========================###
pay.path = "/Users/ylin/My Drive/Cohost/Accounting/"
y25 = paste0('2025.',c(paste0(0,1:9),10:12))
y24 = sub(2025,2024,y25)
owner_payout=NULL
for(k in c(y24[12],y25[1:9]))
{
tmp = read.xlsx(paste0(pay.path,"01-OwnerPayout Records.xlsx"),sheet=k)
owner_payout = rbind(owner_payout,tmp[,c(1,3,5)])
}
for(k in y24[-12])
{
tmp = read.xlsx(paste0(pay.path,"/* Monthly/0-Process & Template/Old files/",
"2024 OwnerPayout Records.xlsx"),sheet=k)
if(!k %in% '2024.11')
{
owner_payout = rbind(owner_payout,data.frame(Date=k,tmp[,c(2,4)]))
}else{
owner_payout = rbind(owner_payout,tmp[,c(1,3,5)])
}
}
jing_property = data.frame(Date=rep(c("2024.05","2024.06","2024.07"),each=4),
Property = c("Elektra 1004",
"Elektra 1108","Elektra 1115","Microsoft 14615-D303"),
Payout = c(-325.99,3942.64,1627.11,3150.69,
4345.90,1249.86,3954.50,3929.28,
1824.40,2392.14,3247.69,4060.26))
owner_payout = rbind(owner_payout %>% filter(!grepl("Jing",Property)),jing_property)
owner_payout = owner_payout %>%
mutate(Year = substr(Date,1,4),
yearmonth = sub(".","-",Date,fixed=T),
Property=trimws(Property,which="right"),
Property=sub("Island ","",Property)) %>%
mutate(Property=sub("SeaTac","Seatac",Property,fixed=T))
txt =c("Microsoft 14645 C19","Microsoft 14620 E205","E205","D201",
"Kirkland D201","Kirkland 11321 - corrected","OSBR - All","OSBR",
"Burien 14407 Middle","Burien 14407 Top","Seatac 12834 - Lower",
"Seatac 12834 - Upper","Bellevue 13020 - already paid")
change = c("Microsoft 14645-C19","Microsoft 14620-E205",
"Total","Kirkland 8252-D201","Kirkland 8252-D201",
"Kirkland 11321","Cottages All OSBR","Cottages All OSBR",
"Burien 14407 middle","Burien 14407 top",
"Seatac 12834 Lower", "Seatac 12834 Upper","Bellevue 13020")
for(i in 1:length(txt))
owner_payout$Property[owner_payout$Property %in% txt[i]] = change[i]
owner_payout %>% filter(Listing %in% "Kirkland 11321" & yearmonth %in% '2024-04')
owner_payout %>% filter(Property %in% "Kirkland 11321" & yearmonth %in% '2024-04')
rm(list=ls())
source("/Users/ylin/My Drive/Cohost/Data and Reporting/Codes/RevenueReport.R")
